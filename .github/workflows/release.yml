name: Release & Deploy

# Triggers:
# 1. CI: Push to main or PRs (Runs tests only)
# 2. CD: Manual trigger or a Published Release (Runs tests -> Builds Binaries -> Deploys Web)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  release:
    types: [published]

# Permissions required for OIDC (Crates.io) and GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # =========================================================
  # JOB 1: TEST (The Gatekeeper)
  # must pass before any release artifacts are built
  # =========================================================
  test:
    name: Test (Native & WASM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install Rust (Stable)
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      # Install Just
      - name: Install Just
        uses: extractions/setup-just@v2

      # Install wasm-pack
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # Run Native Tests
      - name: Run Native Tests
        run: just test-native

      # Run WASM Tests (Headless Chrome is standard on ubuntu-latest)
      - name: Run WASM Tests
        run: just test-wasm

  # =========================================================
  # JOB 2: BUILD BINARIES
  # Runs only on Release or Manual Trigger, and only if tests pass
  # =========================================================
  build_binaries:
    name: Build Binary (${{ matrix.os }})
    needs: test
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: latinga
            asset_name: latinga-linux-x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: latinga.exe
            asset_name: latinga-windows-x86_64.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: latinga
            asset_name: latinga-macos-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Just
        uses: extractions/setup-just@v2

      # Build the binary using your Justfile command
      # We override the cargo build command inside just to ensure the target is correct if needed,
      # but standard 'cargo build --release' usually auto-detects host.
      # For cross-platform safety, we explicitly add the target flag.
      - name: Build Binary
        run: cargo build --release --features cli --target ${{ matrix.target }}

      # Upload the binary to the Release Page
      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}
          name: ${{ matrix.asset_name }} # Rename file on upload for clarity

      # Upload Artifacts for Manual Triggers (so you can download them from Actions tab)
      - name: Upload Artifact (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

  # =========================================================
  # JOB 3: WASM BUILD & WEB DEPLOY
  # Runs only on Release or Manual Trigger
  # =========================================================
  deploy_web:
    name: Build WASM & Deploy Web
    needs: test
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install Just
        uses: extractions/setup-just@v2

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # Build WASM using your Justfile
      # Output goes to: web/pkg/
      - name: Build WASM
        run: just build-wasm

      # 1. Remove the .gitignore that wasm-pack generates so files aren't hidden
      # 2. Create .nojekyll to ensure GitHub Pages serves files starting with "_"
      - name: Prepare for Deployment
        run: |
          rm web/pkg/.gitignore
          touch web/.nojekyll

      # Create a ZIP of the pkg folder for developers to download
      - name: Zip WASM Package
        if: github.event_name == 'release'
        run: |
          cd web
          zip -r ../latinga-wasm-pkg.zip pkg/
      
      - name: Upload WASM Zip to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: latinga-wasm-pkg.zip

      # Deploy the 'web' folder to GitHub Pages
      # This deploys 'web/index.html' and 'web/pkg' to the root of the gh-pages branch.
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./web
          force_orphan: true 

  # =========================================================
  # JOB 4: PUBLISH TO CRATES.IO (FUTURE PROOFING)
  # Currently commented out. Enable when ready.
  # =========================================================
  # publish_crate:
  #   name: Publish to Crates.io
  #   needs: test
  #   if: github.event_name == 'release'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: dtolnay/rust-toolchain@stable
  #     
  #     # This relies on "Trusted Publishing" (OIDC) setup in Crates.io settings
  #     - name: Cargo Publish
  #       run: cargo publish
